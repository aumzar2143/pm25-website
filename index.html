<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PM2.5 ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏•‡∏≥‡∏õ‡∏≤‡∏á ‚Äì Research Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
font-family:sans-serif;
margin:0;
padding:20px;
background:#111;
color:white;
transition:0.5s;
}
.container{max-width:1000px;margin:auto;}
.card{
background:#1e1e1e;
padding:20px;
border-radius:20px;
margin-bottom:20px;
}
.big{
font-size:80px;
font-weight:bold;
}
button{
padding:10px 20px;
border:none;
border-radius:10px;
background:#ffcc00;
cursor:pointer;
font-weight:bold;
}
</style>
</head>
<body>

<div class="container">

<h1>üëë PM2.5 ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏•‡∏≥‡∏õ‡∏≤‡∏á</h1>

<div class="card">
<div class="big" id="aqi">--</div>
<div id="level"></div>
<div id="pm25"></div>
<div id="update"></div>
<div id="advice"></div>
</div>

<div class="card">
<h3>üìä ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á PM2.5</h3>
<canvas id="chart"></canvas>
</div>

<div class="card">
<button onclick="exportCSV()">üì• Export CSV (‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢)</button>
</div>

</div>

<script>

const TOKEN="05dc64914ef2d1b7c4d2678a15450338e660ea53";
const FEED="lampang";

let forecastData=[];

function getLevel(aqi){
if(aqi<=50) return ["üü¢ ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ","#2ecc71"];
if(aqi<=100) return ["üü° ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á","#f1c40f"];
if(aqi<=150) return ["üü† ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û","#e67e22"];
if(aqi<=200) return ["üî¥ ‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û","#e74c3c"];
return ["üü£ ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏°‡∏≤‡∏Å","#8e44ad"];
}

function getAdvice(aqi){
if(aqi<=50) return "‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥";
if(aqi<=100) return "‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á";
if(aqi<=150) return "‡∏Ñ‡∏ß‡∏£‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å N95 ‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ô‡∏≤‡∏ô ‡πÜ";
if(aqi<=200) return "‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á";
return "‡∏á‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ö‡πâ‡∏≤‡∏ô ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ü‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏® ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏ê";
}

async function loadData(){
let res=await fetch(`https://api.waqi.info/feed/${FEED}/?token=${TOKEN}`);
let data=await res.json();

if(data.status==="ok"){
let aqi=data.data.aqi;
let pm=data.data.iaqi.pm25 ? data.data.iaqi.pm25.v : "-";

document.getElementById("aqi").innerText=aqi;
document.getElementById("pm25").innerText="‡∏Ñ‡πà‡∏≤ PM2.5: "+pm+" ¬µg/m¬≥";
document.getElementById("update").innerText="‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: "+data.data.time.s;

let lvl=getLevel(aqi);
document.getElementById("level").innerText=lvl[0];
document.body.style.background=lvl[1];

document.getElementById("advice").innerText="‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: "+getAdvice(aqi);

forecastData=data.data.forecast.daily.pm25;
drawChart(forecastData);
}
}

function drawChart(forecast){
let labels=forecast.map(d=>d.day);
let values=forecast.map(d=>d.avg);

new Chart(document.getElementById("chart"),{
type:"line",
data:{
labels:labels,
datasets:[{
label:"‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ PM2.5 (¬µg/m¬≥)",
data:values
}]
}
});
}

function exportCSV(){
let csv="Date,PM25\n";
forecastData.forEach(d=>{
csv+=`${d.day},${d.avg}\n`;
});
let blob=new Blob([csv],{type:"text/csv"});
let link=document.createElement("a");
link.href=URL.createObjectURL(blob);
link.download="lampang_pm25.csv";
link.click();
}

loadData();

</script>

</body>
</html>
