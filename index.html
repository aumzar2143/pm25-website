<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PM2.5 Thailand Ultra Pro</title>

<style>
body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,sans-serif;
    text-align:center;
    transition:0.5s;
    color:white;
}
.container{padding:20px;max-width:600px;margin:auto;}
h2{margin-top:10px;}
.big{font-size:64px;font-weight:bold;margin:10px 0;}
.card{
    background:rgba(0,0,0,0.25);
    padding:20px;
    margin:15px 0;
    border-radius:20px;
}
select,button{
    padding:12px;
    border-radius:15px;
    border:none;
    font-size:16px;
    width:100%;
    margin-top:10px;
}
button{background:black;color:white;}
small{opacity:0.8}
</style>
</head>

<body>

<div class="container">

<h2>üå´ PM2.5 Thailand Ultra Pro</h2>

<select id="province"></select>

<div class="card">
<div id="location">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
<div class="big" id="pm">--</div>
<div id="status"></div>
<div id="advice" style="margin-top:10px;"></div>
<small id="updated"></small>
</div>

<div class="card">
<h3>üèÜ Top 10 ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡∏ù‡∏∏‡πà‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3>
<div id="top10"></div>
</div>

<button onclick="loadData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>

</div>

<script>

const CACHE_TIME = 60000;
let globalData = [];

async function fetchPrimary(){
    const res = await fetch("https://api.openaq.org/v2/latest?country=TH&parameter=pm25&limit=200");
    const json = await res.json();
    return json.results;
}

async function fetchBackup(){
    const res = await fetch("https://api.waqi.info/feed/bangkok/?token=demo");
    const json = await res.json();
    if(json.status==="ok"){
        return [{
            city:"Bangkok",
            measurements:[{value:json.data.iaqi.pm25.v}]
        }];
    }
    return [];
}

async function loadData(){

    let cache = localStorage.getItem("pmcache");
    let cacheTime = localStorage.getItem("pmtime");

    if(cache && (Date.now()-cacheTime < CACHE_TIME)){
        render(JSON.parse(cache));
        return;
    }

    try{
        let data = await fetchPrimary();
        if(!data || data.length===0) throw "primary fail";
        localStorage.setItem("pmcache", JSON.stringify(data));
        localStorage.setItem("pmtime", Date.now());
        render(data);
    }catch{
        try{
            let backup = await fetchBackup();
            render(backup);
        }catch{
            document.getElementById("location").innerText="‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
        }
    }
}

function render(data){

    globalData = data;

    let select=document.getElementById("province");
    select.innerHTML="";

    data.forEach(d=>{
        let op=document.createElement("option");
        op.value=d.measurements[0].value;
        op.text=d.city || d.location;
        select.appendChild(op);
    });

    select.onchange=()=>{
        updateDisplay(select.selectedOptions[0]);
    };

    updateDisplay(select.selectedOptions[0]);

    let sorted=[...data]
        .sort((a,b)=>b.measurements[0].value - a.measurements[0].value)
        .slice(0,10);

    let html="";
    sorted.forEach(d=>{
        html+=`üëë ${d.city || d.location} - ${d.measurements[0].value}<br>`;
    });
    document.getElementById("top10").innerHTML=html;

    document.getElementById("updated").innerText=
        "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: "+new Date().toLocaleTimeString();
}

function updateDisplay(option){

    let value=parseFloat(option.value);
    document.getElementById("pm").innerText=value;
    document.getElementById("location").innerText="üìç "+option.text;

    let status="",color="",advice="";

    if(value<=25){
        color="#4CAF50";
        status="‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ";
        advice="‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥";
    }else if(value<=50){
        color="#FFEB3B";
        status="‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á";
        advice="‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏£";
    }else if(value<=100){
        color="#FF9800";
        status="‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö";
        advice="‡∏Ñ‡∏ß‡∏£‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å N95 ‡πÅ‡∏•‡∏∞‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á";
    }else if(value<=150){
        color="#F44336";
        status="‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û";
        advice="‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á";
    }else{
        color="#9C27B0";
        status="‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏°‡∏≤‡∏Å";
        advice="‡∏á‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ü‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏® ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£";
    }

    document.body.style.background=color;
    document.getElementById("status").innerText=status;
    document.getElementById("advice").innerText="üõ° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: "+advice;
}

/* GPS ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ */
if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
        console.log("GPS Ready:",pos.coords.latitude);
    });
}

loadData();

</script>

</body>
</html>
