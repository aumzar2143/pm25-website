<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PM2.5 Thailand Ultra Pro</title>

<style>
body{
    margin:0;
    font-family:sans-serif;
    transition:0.5s;
    color:white;
}
.container{padding:15px;}
.card{
    background:rgba(255,255,255,0.15);
    backdrop-filter:blur(12px);
    padding:20px;
    border-radius:20px;
    margin-bottom:15px;
}
.pm{font-size:60px;font-weight:bold;text-align:center;}
.status{text-align:center;font-weight:bold;margin-top:10px;}
button{
    width:100%;
    padding:12px;
    border:none;
    border-radius:12px;
    font-weight:bold;
    margin-top:10px;
}
table{width:100%;font-size:14px;}
td,th{padding:8px;text-align:center;}
.advice{margin-top:10px;font-size:14px;line-height:1.6;}
</style>
</head>
<body>

<div class="container">

<div class="card">
<h2>üëë ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
<div class="pm" id="pm">--</div>
<div class="status" id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
<button onclick="loadData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
<div class="advice" id="advice"></div>
</div>

<div class="card">
<h3>üèÜ 10 ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏≤‡∏ù‡∏∏‡πà‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3>
<table id="table"></table>
</div>

</div>

<script>

const CACHE_TIME = 60000;

function getStatus(pm){
    if(pm<=25) return {text:"üü¢ ‡∏î‡∏µ‡∏°‡∏≤‡∏Å",bg:"#00C853"};
    if(pm<=50) return {text:"üü° ‡∏î‡∏µ",bg:"#FFD600"};
    if(pm<=100) return {text:"üü† ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö",bg:"#FF6D00"};
    if(pm<=200) return {text:"üî¥ ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢",bg:"#D50000"};
    return {text:"üü£ ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏°‡∏≤‡∏Å",bg:"#6A1B9A"};
}

function getAdvice(pm){
    if(pm<=25) return "‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥";
    if(pm<=50) return "‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏ß‡∏£‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£";
    if(pm<=100) return "‡∏Ñ‡∏ß‡∏£‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å PM2.5 ‡πÅ‡∏•‡∏∞‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á";
    if(pm<=200) return "‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á ‡∏™‡∏ß‡∏° N95 ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
    return "‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ü‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏®";
}

async function fetchData(){

    const cache = localStorage.getItem("pm_data");
    const cacheTime = localStorage.getItem("pm_time");

    if(cache && cacheTime && Date.now()-cacheTime < CACHE_TIME){
        return JSON.parse(cache);
    }

    const api = "https://api.allorigins.win/raw?url=" +
        encodeURIComponent("https://air4thai.pcd.go.th/services/getNewAQI_JSON.php");

    const res = await fetch(api);
    const data = await res.json();

    localStorage.setItem("pm_data",JSON.stringify(data));
    localStorage.setItem("pm_time",Date.now());

    return data;
}

async function loadData(){
    document.getElementById("status").innerText="‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";

    try{
        const data = await fetchData();

        const stations = data.stations
            .map(s=>({
                name:s.areaTH,
                pm:parseFloat(s.PM25?.aqi)
            }))
            .filter(x=>!isNaN(x.pm))
            .sort((a,b)=>b.pm-a.pm);

        const top10 = stations.slice(0,10);

        let html="<tr><th>#</th><th>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</th><th>PM2.5</th></tr>";
        top10.forEach((s,i)=>{
            html+=`<tr><td>${i+1}</td><td>${s.name}</td><td>${s.pm}</td></tr>`;
        });
        document.getElementById("table").innerHTML=html;

        // ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        if(navigator.geolocation){
            navigator.geolocation.getCurrentPosition(pos=>{
                const user = stations[0]; // fallback ‡∏ñ‡πâ‡∏≤ map ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á
                const status = getStatus(user.pm);
                document.getElementById("pm").innerText=user.pm;
                document.getElementById("status").innerText=user.name+" "+status.text;
                document.getElementById("advice").innerText=getAdvice(user.pm);
                document.body.style.background=status.bg;
            });
        }

    }catch(e){
        document.getElementById("status").innerText="‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    }
}

window.onload=loadData;
setInterval(loadData,60000);

</script>

</body>
</html>
