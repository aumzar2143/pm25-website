<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PM2.5 Ultra Final</title>

<style>
body{
    margin:0;
    font-family:'Segoe UI',sans-serif;
    transition: background 0.5s ease;
    color:white;
}
.container{padding:15px;}
.card{
    background:rgba(255,255,255,0.15);
    backdrop-filter:blur(15px);
    border-radius:20px;
    padding:20px;
    margin-bottom:15px;
}
h1{text-align:center;font-size:22px;}
.pm-value{font-size:60px;font-weight:bold;text-align:center;}
.status{text-align:center;font-size:18px;font-weight:bold;}
button{
    width:100%;padding:12px;border:none;border-radius:15px;
    font-size:16px;font-weight:bold;background:white;color:black;margin-top:10px;
}
table{width:100%;font-size:14px;}
th,td{padding:8px;text-align:center;}
.advice{font-size:14px;margin-top:10px;line-height:1.6;}
</style>
</head>
<body>

<div class="container">

<div class="card">
<h1>üëë ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h1>
<div class="pm-value" id="pmValue">--</div>
<div class="status" id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...</div>
<button onclick="loadData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
<div class="advice" id="adviceText"></div>
</div>

<div class="card">
<h3>üèÜ Top 10 ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ù‡∏∏‡πà‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3>
<table>
<thead>
<tr><th>#</th><th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th><th>PM2.5</th></tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

</div>

<script>

const CACHE_TIME = 60000;

function getStatus(pm){
    if(pm <= 50) return {text:"üü¢ ‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ‡∏°‡∏≤‡∏Å", color:"linear-gradient(135deg,#00C853,#69F0AE)"};
    if(pm <= 100) return {text:"üü° ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á", color:"linear-gradient(135deg,#FFD600,#FFEA00)"};
    if(pm <= 150) return {text:"üü† ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö", color:"linear-gradient(135deg,#FF6D00,#FFAB40)"};
    if(pm <= 200) return {text:"üî¥ ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢", color:"linear-gradient(135deg,#D50000,#FF5252)"};
    return {text:"üü£ ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏°‡∏≤‡∏Å", color:"linear-gradient(135deg,#6A1B9A,#AB47BC)"};
}

// ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ù‡∏∏‡πà‡∏ô‡∏ï‡∏≤‡∏°‡∏Å‡∏£‡∏°‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢
function getAdvice(pm){
    if(pm <= 50) return "üòÉ ‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥";
    if(pm <= 100) return "üò∑ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏ß‡∏£‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á";
    if(pm <= 150) return "‚ö†Ô∏è ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏Ñ‡∏ß‡∏£‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å PM2.5 ‡πÅ‡∏•‡∏∞‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£";
    if(pm <= 200) return "üö´ ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á ‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å N95 ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
    return "‚ùó ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ü‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏® ‡πÅ‡∏•‡∏∞‡∏™‡∏ß‡∏° N95 ‡∏´‡∏≤‡∏Å‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô";
}

async function loadData(){

    const cached = localStorage.getItem("pm_cache");
    const cacheTime = localStorage.getItem("pm_cache_time");

    let provinceData;

    if(cached && cacheTime && (Date.now() - cacheTime < CACHE_TIME)){
        provinceData = JSON.parse(cached);
    }else{
        const response = await fetch("https://api.openaq.org/v2/latest?country=TH&parameter=pm25&limit=1000");
        const result = await response.json();

        provinceData = {};
        result.results.forEach(item=>{
            const province = item.city;
            const pm = item.measurements[0].value;
            if(!provinceData[province] || pm > provinceData[province]){
                provinceData[province] = pm;
            }
        });

        localStorage.setItem("pm_cache", JSON.stringify(provinceData));
        localStorage.setItem("pm_cache_time", Date.now());
    }

    renderTop10(provinceData);
    detectUserProvince(provinceData);
}

function renderTop10(data){
    const sorted = Object.entries(data).sort((a,b)=> b[1]-a[1]);
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML="";
    sorted.slice(0,10).forEach((item,index)=>{
        const row = document.createElement("tr");
        row.innerHTML=`<td>${index+1}</td><td>${item[0]}</td><td>${item[1]}</td>`;
        tbody.appendChild(row);
    });
}

function detectUserProvince(data){
    if(!navigator.geolocation){
        document.getElementById("statusText").innerText="‚ùå GPS ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö";
        return;
    }

    navigator.geolocation.getCurrentPosition(async position=>{
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;

        const geo = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
        const geoData = await geo.json();

        const province = geoData.address.state || geoData.address.county;

        const pm = data[province];

        if(pm){
            const status = getStatus(pm);
            document.getElementById("pmValue").innerText=pm;
            document.getElementById("statusText").innerText=province+" "+status.text;
            document.getElementById("adviceText").innerText=getAdvice(pm);
            document.body.style.background=status.color;
        }else{
            document.getElementById("statusText").innerText="‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì";
        }

    },()=>{
        document.getElementById("statusText").innerText="‚ùå ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï GPS ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì";
    });
}

window.onload = loadData;
setInterval(loadData,60000);

</script>

</body>
</html>
