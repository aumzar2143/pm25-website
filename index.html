<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PM2.5 Health Surveillance System</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
    margin:0;
    font-family:Arial;
    text-align:center;
    padding:20px;
    transition:background 0.5s;
    color:white;
}
.container{
    max-width:500px;
    margin:auto;
}
.card{
    background:white;
    color:black;
    padding:20px;
    border-radius:20px;
    box-shadow:0 10px 30px rgba(0,0,0,0.3);
}
button{
    padding:8px 15px;
    margin:5px;
    border:none;
    border-radius:10px;
    background:#2980b9;
    color:white;
    font-size:14px;
}
canvas{
    margin-top:20px;
}
.small{
    font-size:12px;
}
</style>
</head>
<body>

<div class="container">

<h2>üå´ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á PM2.5</h2>

<div class="card">

<div id="location">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...</div>
<div id="result">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

<button onclick="init()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
<button onclick="exportCSV()">Export CSV</button>

<canvas id="chart"></canvas>

<div class="small">
‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢ (24 ‡∏ä‡∏°.) = 50 ¬µg/m¬≥
</div>

</div>

</div>

<script>
const apiKey="05dc64914ef2d1b7c4d2678a15450338e660ea53";
const THAI_STANDARD=50;
let chart;
let historyData=[];

function getAdvice(pm){
    if(pm<=25){
        return {
            color:"#2ecc71",
            level:"‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ",
            advice:"‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏î‡πâ"
        };
    }
    if(pm<=50){
        return {
            color:"#f1c40f",
            level:"‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö",
            advice:"‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á"
        };
    }
    if(pm<=90){
        return {
            color:"#e67e22",
            level:"‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û",
            advice:"‡∏Ñ‡∏ß‡∏£‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å N95 ‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á"
        };
    }
    return {
        color:"#e74c3c",
        level:"‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û",
        advice:"‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ü‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏® ‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á"
    };
}

async function fetchPM(lat,lon){
    const url=`https://api.waqi.info/feed/geo:${lat};${lon}/?token=${apiKey}`;
    const response=await fetch(url);
    const data=await response.json();
    if(data.status!=="ok") return;

    const pm=data.data.iaqi.pm25?.v || 0;
    const station=data.data.city.name;

    const info=getAdvice(pm);

    document.body.style.background=info.color;

    document.getElementById("location").innerHTML=
        `<strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ:</strong> ${station}`;

    document.getElementById("result").innerHTML=`
        <h1>${pm} ¬µg/m¬≥</h1>
        <h3>${info.level}</h3>
        <p>${info.advice}</p>
    `;

    if(pm>THAI_STANDARD){
        notify(pm);
    }

    saveHistory(pm);
    updateChart();
}

function saveHistory(value){
    const time=new Date().toLocaleTimeString();
    historyData.push({time,value});
    if(historyData.length>10){
        historyData.shift();
    }
}

function updateChart(){
    const ctx=document.getElementById("chart");

    if(chart) chart.destroy();

    chart=new Chart(ctx,{
        type:'line',
        data:{
            labels:historyData.map(d=>d.time),
            datasets:[
                {
                    label:'PM2.5',
                    data:historyData.map(d=>d.value),
                    borderColor:'#2980b9',
                    fill:false
                },
                {
                    label:'‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢',
                    data:Array(historyData.length).fill(THAI_STANDARD),
                    borderColor:'#e74c3c',
                    borderDash:[5,5],
                    fill:false
                }
            ]
        },
        options:{
            scales:{
                y:{beginAtZero:true}
            }
        }
    });
}

function notify(value){
    if(Notification.permission==="granted"){
        new Notification("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô PM2.5 ‡∏™‡∏π‡∏á",{
            body:`‡∏Ñ‡πà‡∏≤‡∏ù‡∏∏‡πà‡∏ô ${value} ¬µg/m¬≥ ‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô`
        });
    }
}

function exportCSV(){
    let csv="Time,PM2.5\n";
    historyData.forEach(d=>{
        csv+=`${d.time},${d.value}\n`;
    });

    const blob=new Blob([csv],{type:'text/csv'});
    const link=document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.download="pm25_history.csv";
    link.click();
}

function init(){
    if("Notification" in window){
        Notification.requestPermission();
    }

    if("geolocation" in navigator){
        navigator.geolocation.getCurrentPosition(pos=>{
            fetchPM(pos.coords.latitude,pos.coords.longitude);
        });
    }
}

init();
</script>

</body>
</html>
