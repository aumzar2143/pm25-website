<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PM2.5 ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏•‡∏≥‡∏õ‡∏≤‡∏á</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#222;
  color:white;
  text-align:center;
  transition:0.4s;
}
.card{
  background:#111;
  margin:15px;
  padding:20px;
  border-radius:20px;
}
button{
  padding:10px 15px;
  border:none;
  border-radius:10px;
  margin:5px;
  font-size:14px;
  cursor:pointer;
}
.refresh{background:#00c853;color:white;}
.gps{background:#2962ff;color:white;}
.export{background:#ffc107;color:black;}
.rank-card{
  background:#1a1a1a;
  margin:10px;
  padding:10px;
  border-radius:10px;
}
</style>
</head>

<body>

<h2>üëë PM2.5 ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏•‡∏≥‡∏õ‡∏≤‡∏á</h2>

<div class="card">
<h1 id="pmValue">--</h1>
<p id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
<p id="locationText"></p>

<button class="refresh" onclick="loadData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
<button class="gps" onclick="useGPS()">üìç ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
</div>

<div class="card">
<h3>üìä ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏±‡∏ô</h3>
<canvas id="chart"></canvas>
</div>

<div class="card">
<h3>üèÜ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÉ‡∏ô‡∏•‡∏≥‡∏õ‡∏≤‡∏á</h3>
<div id="ranking"></div>
</div>

<div class="card">
<button class="export" onclick="exportCSV()">üì• Export CSV (‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢)</button>
</div>

<script>
const token = "05dc64914ef2d1b7c4d2678a15450338e660ea53";
let chart;

// ===== Cache 1 ‡∏ô‡∏≤‡∏ó‡∏µ =====
function getCache(){
  const cache = localStorage.getItem("pmData");
  if(!cache) return null;
  const data = JSON.parse(cache);
  if(Date.now()-data.time < 60000) return data.value;
  return null;
}

function setCache(value){
  localStorage.setItem("pmData", JSON.stringify({
    time:Date.now(),
    value:value
  }));
}

// ===== ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á =====
function setBG(pm){
  if(pm<=25) document.body.style.background="#2e7d32";
  else if(pm<=50) document.body.style.background="#f9a825";
  else if(pm<=100) document.body.style.background="#ef6c00";
  else document.body.style.background="#c62828";
}

// ===== ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• =====
async function loadData(){
  let cached = getCache();
  if(cached){
    render(cached);
    return;
  }

  const res = await fetch(`https://api.waqi.info/feed/lampang/?token=${token}`);
  const data = await res.json();
  const pm = data.data.iaqi.pm25.v;
  setCache(pm);
  render(pm);
}

function render(pm){
  document.getElementById("pmValue").innerText = pm + " ¬µg/m¬≥";
  document.getElementById("statusText").innerText = getAdvice(pm);
  setBG(pm);
  loadChart();
  loadRanking();
}

// ===== ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏£‡∏°‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢ =====
function getAdvice(pm){
  if(pm<=25) return "üü¢ ‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ ‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥";
  if(pm<=50) return "üü° ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö ‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á";
  if(pm<=100) return "üü† ‡∏Ñ‡∏ß‡∏£‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å N95";
  return "üî¥ ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢ ‡∏Ñ‡∏ß‡∏£‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á";
}

// ===== ‡∏Å‡∏£‡∏≤‡∏ü =====
function loadChart(){
  const ctx = document.getElementById("chart");
  if(chart) chart.destroy();
  chart = new Chart(ctx,{
    type:"line",
    data:{
      labels:["1","2","3","4","5","6","7"],
      datasets:[{
        label:"PM2.5",
        data:[150,140,170,160,200,180,160]
      }]
    }
  });
}

// ===== Ranking ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ =====
function loadRanking(){
  const districts=[
    {name:"‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏•‡∏≥‡∏õ‡∏≤‡∏á",pm:107},
    {name:"‡πÅ‡∏°‡πà‡πÄ‡∏°‡∏≤‡∏∞",pm:120},
    {name:"‡∏á‡∏≤‡∏ß",pm:95},
    {name:"‡πÄ‡∏Å‡∏≤‡∏∞‡∏Ñ‡∏≤",pm:110},
    {name:"‡πÅ‡∏à‡πâ‡∏´‡πà‡∏°",pm:130}
  ];
  districts.sort((a,b)=>b.pm-a.pm);

  let html="";
  districts.forEach((d,i)=>{
    html+=`<div class="rank-card">
      ${i+1}. ${d.name} - ${d.pm} ¬µg/m¬≥
    </div>`;
  });
  document.getElementById("ranking").innerHTML=html;
}

// ===== GPS =====
function useGPS(){
  if(!navigator.geolocation){
    alert("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS");
    return;
  }
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude;
    const lon=pos.coords.longitude;
    document.getElementById("locationText").innerText=
      "üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: "+lat.toFixed(4)+","+lon.toFixed(4);
  });
}

// ===== Export CSV =====
function exportCSV(){
  const data="District,PM2.5\n‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏•‡∏≥‡∏õ‡∏≤‡∏á,107\n‡πÅ‡∏°‡πà‡πÄ‡∏°‡∏≤‡∏∞,120";
  const blob=new Blob([data],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="pm25_lampang.csv";
  a.click();
}

loadData();
</script>

</body>
</html>
