<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PM2.5 ‡∏•‡∏≥‡∏õ‡∏≤‡∏á Full Research</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{
  margin:0;
  font-family:system-ui;
  color:white;
  text-align:center;
  transition:0.4s;
}
.card{
  background:rgba(0,0,0,0.8);
  margin:15px;
  padding:20px;
  border-radius:20px;
}
button{
  padding:10px 15px;
  border:none;
  border-radius:10px;
  margin:5px;
  font-size:14px;
  cursor:pointer;
}
.refresh{background:#00c853;color:white;}
.gps{background:#2962ff;color:white;}
.export{background:#ffc107;color:black;}
.rank{
  background:#1a1a1a;
  margin:5px;
  padding:10px;
  border-radius:10px;
}
.highlight{
  border:2px solid #fff;
}
</style>
</head>

<body>

<h2>üëë PM2.5 ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏•‡∏≥‡∏õ‡∏≤‡∏á</h2>

<div class="card">
<h1 id="pmValue">--</h1>
<p id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
<p id="locationText"></p>

<button class="refresh" onclick="loadAll()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
<button class="gps" onclick="useGPS()">üìç ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
</div>

<div class="card">
<h3>üìä ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
<canvas id="chart"></canvas>
<p id="avgText"></p>
</div>

<div class="card">
<h3>üèÜ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÉ‡∏ô‡∏•‡∏≥‡∏õ‡∏≤‡∏á</h3>
<div id="ranking"></div>
</div>

<div class="card">
<button class="export" onclick="exportCSV()">üì• Export CSV</button>
</div>

<script>
const token="05dc64914ef2d1b7c4d2678a15450338e660ea53";
let chart;
let userDistrict=null;

const districts={
"‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏•‡∏≥‡∏õ‡∏≤‡∏á":[18.2888,99.4908],
"‡πÅ‡∏°‡πà‡πÄ‡∏°‡∏≤‡∏∞":[18.2923,99.7567],
"‡∏á‡∏≤‡∏ß":[18.7833,99.9667],
"‡πÅ‡∏à‡πâ‡∏´‡πà‡∏°":[18.7167,99.6167],
"‡πÄ‡∏Å‡∏≤‡∏∞‡∏Ñ‡∏≤":[18.2000,99.3667],
"‡πÄ‡∏ñ‡∏¥‡∏ô":[17.6333,99.2333],
"‡πÅ‡∏°‡πà‡∏û‡∏£‡∏¥‡∏Å":[17.5167,99.1500],
"‡∏ß‡∏±‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠":[19.1500,99.6000],
"‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏á‡∏≤‡∏°":[18.1167,99.1500],
"‡∏™‡∏ö‡∏õ‡∏£‡∏≤‡∏ö":[17.8833,99.3500],
"‡∏´‡πâ‡∏≤‡∏á‡∏â‡∏±‡∏ï‡∏£":[18.3167,99.3500],
"‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏õ‡∏≤‡∏ô":[18.7667,99.4500],
"‡πÅ‡∏°‡πà‡∏ó‡∏∞":[18.1000,99.5667]
};

function setBG(pm){
if(pm<=25) document.body.style.background="#2e7d32";
else if(pm<=50) document.body.style.background="#f9a825";
else if(pm<=100) document.body.style.background="#ef6c00";
else if(pm<=150) document.body.style.background="#c62828";
else document.body.style.background="#6a1b9a";
}

function advice(pm){
if(pm<=25) return "üü¢ ‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ";
if(pm<=50) return "üü° ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö";
if(pm<=100) return "üü† ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏™‡πà N95";
if(pm<=150) return "üî¥ ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á";
return "üü£ ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏°‡∏≤‡∏Å";
}

async function fetchPM(lat,lon){
const res=await fetch(`https://api.waqi.info/feed/geo:${lat};${lon}/?token=${token}`);
const data=await res.json();
return data.data.iaqi.pm25?data.data.iaqi.pm25.v:0;
}

async function loadAll(){
let results=[];
for(const name in districts){
let [lat,lon]=districts[name];
let pm=await fetchPM(lat,lon);
results.push({name,pm});
}
results.sort((a,b)=>b.pm-a.pm);

let html="";
results.forEach((d,i)=>{
let cls="rank";
if(d.name===userDistrict) cls+=" highlight";
html+=`<div class="${cls}">
${i+1}. ${d.name} - ${d.pm} ¬µg/m¬≥
</div>`;
});
document.getElementById("ranking").innerHTML=html;

let mainPM=results[0].pm;
document.getElementById("pmValue").innerText=mainPM+" ¬µg/m¬≥";
document.getElementById("statusText").innerText=advice(mainPM);
setBG(mainPM);

loadChart(results.map(r=>r.pm));
}

function loadChart(data){
if(chart) chart.destroy();
chart=new Chart(document.getElementById("chart"),{
type:"line",
data:{
labels:Object.keys(districts),
datasets:[{label:"PM2.5",data:data}]
}
});
let avg=data.reduce((a,b)=>a+b)/data.length;
document.getElementById("avgText").innerText=
"‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: "+avg.toFixed(2)+" ¬µg/m¬≥";
}

function useGPS(){
navigator.geolocation.getCurrentPosition(async pos=>{
let lat=pos.coords.latitude;
let lon=pos.coords.longitude;
document.getElementById("locationText").innerText=
"üìç ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: "+lat.toFixed(4)+","+lon.toFixed(4);
userDistrict=findClosest(lat,lon);
loadAll();
});
}

function findClosest(lat,lon){
let min=999999;
let closest=null;
for(const name in districts){
let [dlat,dlon]=districts[name];
let dist=Math.hypot(lat-dlat,lon-dlon);
if(dist<min){min=dist;closest=name;}
}
return closest;
}

function exportCSV(){
let csv="District,PM2.5\n";
document.querySelectorAll(".rank").forEach(el=>{
csv+=el.innerText.replace(" - ",",")+"\n";
});
let blob=new Blob([csv],{type:"text/csv"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="pm25_lampang_full.csv";
a.click();
}

loadAll();
</script>

</body>
</html>
