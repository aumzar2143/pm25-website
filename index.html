<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PM2.5 Thailand Dashboard</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: 'Prompt', sans-serif;
    margin:0;
    background:#f4f6f9;
}

header {
    background:#0d6efd;
    color:white;
    padding:15px;
    text-align:center;
    font-size:20px;
}

#map {
    height:400px;
}

.container {
    padding:20px;
}

table {
    width:100%;
    border-collapse: collapse;
    margin-top:20px;
}

th, td {
    padding:10px;
    border:1px solid #ddd;
    text-align:center;
}

th {
    background:#0d6efd;
    color:white;
}

.level-good { background:#4CAF50; color:white; }
.level-moderate { background:#FFC107; }
.level-unhealthy { background:#FF5722; color:white; }
.level-very { background:#B71C1C; color:white; }

#advice {
    margin-top:20px;
    padding:15px;
    background:white;
    border-radius:10px;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
}
</style>
</head>

<body>

<header>
รายงานสถานการณ์ PM2.5 ประเทศไทย (Real-time)
</header>

<div id="map"></div>

<div class="container">

<canvas id="pmChart"></canvas>

<div id="advice">
<h3>คำแนะนำด้านสุขภาพ (ตามกรมอนามัย)</h3>
<p id="adviceText">กำลังโหลดข้อมูล...</p>
</div>

<table id="pmTable">
<thead>
<tr>
<th>จังหวัด</th>
<th>PM2.5 (µg/m³)</th>
</tr>
</thead>
<tbody></tbody>
</table>

</div>

<script>

// ====================== MAP =========================
const map = L.map('map').setView([13.736717, 100.523186], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
}).addTo(map);

// ====================== API =========================
// *** ตัวอย่าง API JSON ต้องเปลี่ยนเป็นของจริง ***
const API_URL = "https://pm25.gistda.or.th/json/pm25_all.json";

fetch(API_URL)
.then(res => res.json())
.then(data => {

    const tableBody = document.querySelector("#pmTable tbody");
    const labels = [];
    const values = [];

    data.sort((a,b)=> b.pm25 - a.pm25);

    data.forEach(loc => {

        // ----- Map -----
        let color = getColor(loc.pm25);

        L.circle([loc.lat, loc.lon], {
            color: color,
            radius: 8000
        }).addTo(map)
        .bindPopup(`<b>${loc.province}</b><br>PM2.5: ${loc.pm25}`);

        // ----- Table -----
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${loc.province}</td>
            <td>${loc.pm25}</td>
        `;
        tableBody.appendChild(row);

        labels.push(loc.province);
        values.push(loc.pm25);
    });

    createChart(labels.slice(0,15), values.slice(0,15));
    showAdvice(values[0]);
    sendNotification(values[0]);

});

// ====================== COLOR LEVEL =========================
function getColor(pm){
    if(pm <= 25) return "#4CAF50";
    if(pm <= 50) return "#FFC107";
    if(pm <= 75) return "#FF5722";
    return "#B71C1C";
}

// ====================== CHART =========================
function createChart(labels, data){
    new Chart(document.getElementById("pmChart"), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'PM2.5 µg/m³',
                data: data
            }]
        }
    });
}

// ====================== HEALTH ADVICE =========================
function showAdvice(pm){
    let text = "";

    if(pm <= 25){
        text = "คุณภาพอากาศดี สามารถทำกิจกรรมกลางแจ้งได้ตามปกติ";
    } else if(pm <= 50){
        text = "เริ่มมีผลกระทบต่อสุขภาพ กลุ่มเสี่ยงควรลดเวลาทำกิจกรรมกลางแจ้ง";
    } else if(pm <= 75){
        text = "ควรสวมหน้ากาก N95 และหลีกเลี่ยงกิจกรรมกลางแจ้ง";
    } else {
        text = "อันตรายต่อสุขภาพ ควรอยู่ภายในอาคาร ปิดประตูหน้าต่าง ใช้เครื่องฟอกอากาศ";
    }

    document.getElementById("adviceText").innerText = text;
}

// ====================== NOTIFICATION =========================
function sendNotification(pm){

    if (!("Notification" in window)) return;

    Notification.requestPermission().then(permission => {
        if(permission === "granted" && pm > 75){
            new Notification("แจ้งเตือน PM2.5 สูง!", {
                body: "ระดับฝุ่นเกินมาตรฐาน โปรดสวมหน้ากาก N95",
            });
        }
    });

}

</script>

</body>
</html>
