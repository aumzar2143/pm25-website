<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PM2.5 Thailand Ultra Pro</title>

<style>
body{
    margin:0;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    text-align:center;
    transition:0.5s;
}
.container{
    padding:20px;
}
.big{
    font-size:60px;
    font-weight:bold;
}
.select{
    padding:10px;
    font-size:16px;
    border-radius:10px;
    margin-top:10px;
}
.card{
    background:white;
    padding:15px;
    margin:15px;
    border-radius:20px;
    box-shadow:0 5px 15px rgba(0,0,0,0.1);
}
button{
    padding:10px 15px;
    border:none;
    border-radius:15px;
    background:#333;
    color:white;
}
</style>
</head>

<body>

<div class="container">

<h2>üå´ PM2.5 Thailand Ultra Pro</h2>

<select id="province" class="select"></select>

<div class="card">
<div id="location"></div>
<div class="big" id="pm">--</div>
<div id="status"></div>
</div>

<div class="card">
<h3>üèÜ Top 10 ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢</h3>
<div id="top10"></div>
</div>

<button onclick="loadData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>

</div>

<script>

const CACHE_TIME = 60000;

async function loadData(){

    let cache = localStorage.getItem("pmcache");
    let cacheTime = localStorage.getItem("pmtime");

    if(cache && (Date.now()-cacheTime < CACHE_TIME)){
        render(JSON.parse(cache));
        return;
    }

    try{
        const res = await fetch("https://air4thai.pcd.go.th/services/getNewAQI_JSON.php");
        const data = await res.json();
        localStorage.setItem("pmcache", JSON.stringify(data));
        localStorage.setItem("pmtime", Date.now());
        render(data);
    }catch(e){
        alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
    }
}

function render(data){

    const stations = data.stations;

    let provinceSelect = document.getElementById("province");
    provinceSelect.innerHTML="";

    stations.forEach(s=>{
        let op = document.createElement("option");
        op.value = s.AQI.aqi;
        op.text = s.areaEN;
        provinceSelect.appendChild(op);
    });

    provinceSelect.onchange = ()=>{
        updateDisplay(provinceSelect.selectedOptions[0]);
    }

    updateDisplay(provinceSelect.selectedOptions[0]);

    let sorted = [...stations].sort((a,b)=>b.AQI.aqi - a.AQI.aqi).slice(0,10);
    let topHTML="";
    sorted.forEach(s=>{
        topHTML+=`üëë ${s.areaEN} - ${s.AQI.aqi}<br>`;
    });
    document.getElementById("top10").innerHTML=topHTML;
}

function updateDisplay(option){
    let value = option.value;
    document.getElementById("pm").innerText=value;
    document.getElementById("location").innerText="üìç "+option.text;

    if(value<=50){
        document.body.style.background="#4CAF50";
        document.getElementById("status").innerText="‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ";
    }else if(value<=100){
        document.body.style.background="#FFEB3B";
        document.getElementById("status").innerText="‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á";
    }else if(value<=150){
        document.body.style.background="#FF9800";
        document.getElementById("status").innerText="‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö";
    }else if(value<=200){
        document.body.style.background="#F44336";
        document.getElementById("status").innerText="‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û";
    }else{
        document.body.style.background="#9C27B0";
        document.getElementById("status").innerText="‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏°‡∏≤‡∏Å";
    }
}

/* GPS */
if(navigator.geolocation){
navigator.geolocation.getCurrentPosition(pos=>{
    console.log("GPS Ready");
});
}

loadData();

</script>

</body>
</html>
