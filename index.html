<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PM2.5 Thailand Research Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,sans-serif;text-align:center;transition:.4s;color:#fff}
.container{max-width:720px;margin:auto;padding:18px}
.card{background:rgba(0,0,0,.25);padding:18px;border-radius:18px;margin:14px 0}
.big{font-size:64px;font-weight:700;margin:6px 0}
select,button{width:100%;padding:12px;border-radius:14px;border:none;margin-top:10px;font-size:16px}
button{background:#000;color:#fff}
small{opacity:.9}
hr{border:0;border-top:1px solid rgba(255,255,255,.3);margin:12px 0}
.badge{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.2);margin:4px 2px}
</style>
</head>
<body>
<div class="container">

<h2>ğŸŒ« PM2.5 Thailand â€“ Research Dashboard</h2>

<button onclick="requestLocation()">ğŸ“ à¹ƒà¸Šà¹‰à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸‚à¸­à¸‡à¸‰à¸±à¸™ (GPS)</button>
<select id="stationSelect"></select>

<div class="card">
  <div id="stationName">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...</div>
  <div class="big" id="pmValue">--</div>
  <div id="levelText"></div>
  <div id="coords"></div>
  <hr>
  <div>
    <span class="badge">à¸¡à¸²à¸•à¸£à¸à¸²à¸™à¹„à¸—à¸¢ 24 à¸Šà¸¡.: â‰¤ 37.5 Âµg/mÂ³</span>
    <span class="badge">WHO 24 à¸Šà¸¡.: â‰¤ 15 Âµg/mÂ³</span>
  </div>
  <div id="comparison"></div>
  <small id="updated"></small>
</div>

<div class="card">
  <h3>ğŸ“ˆ à¸à¸£à¸²à¸Ÿà¸¢à¹‰à¸­à¸™à¸«à¸¥à¸±à¸‡ 24 à¸Šà¸¡.</h3>
  <canvas id="pmChart"></canvas>
</div>

<div class="card">
  <h3>ğŸ† 10 à¸ªà¸–à¸²à¸™à¸µà¸„à¹ˆà¸²à¸à¸¸à¹ˆà¸™à¸ªà¸¹à¸‡à¸ªà¸¸à¸”</h3>
  <div id="top10"></div>
</div>

<button onclick="loadStations()">ğŸ”„ à¸£à¸µà¹€à¸Ÿà¸£à¸Šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥</button>

</div>

<script>
const TOKEN="demo";
const CACHE_TIME=60000;
let stations=[];
let chart;

/* à¹‚à¸«à¸¥à¸”à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸ªà¸–à¸²à¸™à¸µà¸—à¸±à¹‰à¸‡à¸›à¸£à¸°à¹€à¸—à¸¨ */
async function loadStations(){
  let cache=localStorage.getItem("stations");
  let time=localStorage.getItem("time");
  if(cache && Date.now()-time<CACHE_TIME){
    stations=JSON.parse(cache);
    renderStations();
    return;
  }
  const res=await fetch(`https://api.waqi.info/search/?token=${TOKEN}&keyword=thailand`);
  const json=await res.json();
  stations=json.data.filter(s=>s.aqi!="-").map(s=>({
    name:s.station.name,
    lat:s.station.geo[0],
    lon:s.station.geo[1],
    aqi:s.aqi,
    uid:s.uid
  }));
  localStorage.setItem("stations",JSON.stringify(stations));
  localStorage.setItem("time",Date.now());
  renderStations();
}

function renderStations(){
  const select=document.getElementById("stationSelect");
  select.innerHTML="";
  stations.forEach(s=>{
    let op=document.createElement("option");
    op.value=s.uid;
    op.text=s.name;
    select.appendChild(op);
  });
  select.onchange=()=>loadStationDetail(select.value);
  loadStationDetail(select.value);
  renderTop10();
}

/* à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸–à¸²à¸™à¸µ + à¸à¸£à¸²à¸Ÿ */
async function loadStationDetail(uid){
  const res=await fetch(`https://api.waqi.info/feed/@${uid}/?token=${TOKEN}`);
  const json=await res.json();
  const data=json.data;

  let pm=data.iaqi.pm25?data.iaqi.pm25.v:"-";
  let lat=data.city.geo[0];
  let lon=data.city.geo[1];

  document.getElementById("stationName").innerText="ğŸ“ "+data.city.name;
  document.getElementById("pmValue").innerText=pm+" Âµg/mÂ³";
  document.getElementById("coords").innerText="à¸à¸´à¸à¸±à¸”: "+lat+", "+lon;
  document.getElementById("updated").innerText="à¸­à¸±à¸›à¹€à¸”à¸•: "+new Date().toLocaleString();

  evaluateLevel(pm);
  renderChart(data.forecast.daily.pm25);
}

/* à¸£à¸°à¸”à¸±à¸šà¸ªà¸¸à¸‚à¸ à¸²à¸ */
function evaluateLevel(pm){
  pm=parseFloat(pm);
  let text,color;
  if(pm<=15){text="à¸”à¸µà¸¡à¸²à¸ (à¸•à¸²à¸¡ WHO)";color="#4CAF50";}
  else if(pm<=37.5){text="à¸œà¹ˆà¸²à¸™à¸¡à¸²à¸•à¸£à¸à¸²à¸™à¹„à¸—à¸¢";color="#8BC34A";}
  else if(pm<=75){text="à¹€à¸£à¸´à¹ˆà¸¡à¸¡à¸µà¸œà¸¥à¸à¸£à¸°à¸—à¸š";color="#FF9800";}
  else if(pm<=150){text="à¸¡à¸µà¸œà¸¥à¸à¸£à¸°à¸—à¸šà¸•à¹ˆà¸­à¸ªà¸¸à¸‚à¸ à¸²à¸";color="#F44336";}
  else{text="à¸­à¸±à¸™à¸•à¸£à¸²à¸¢à¸¡à¸²à¸";color="#9C27B0";}
  document.body.style.background=color;
  document.getElementById("levelText").innerText=text;

  let compare="";
  if(pm>37.5) compare+="âš  à¹€à¸à¸´à¸™à¸¡à¸²à¸•à¸£à¸à¸²à¸™à¹„à¸—à¸¢ ";
  if(pm>15) compare+="âš  à¹€à¸à¸´à¸™à¸¡à¸²à¸•à¸£à¸à¸²à¸™ WHO";
  if(compare==="") compare="à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¹€à¸à¸“à¸‘à¹Œà¸›à¸¥à¸­à¸”à¸ à¸±à¸¢";
  document.getElementById("comparison").innerText=compare;
}

/* à¸à¸£à¸²à¸Ÿà¸¢à¹‰à¸­à¸™à¸«à¸¥à¸±à¸‡ */
function renderChart(forecast){
  const ctx=document.getElementById("pmChart").getContext("2d");
  const labels=forecast.map(d=>d.day);
  const values=forecast.map(d=>d.avg);
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:"line",
    data:{labels:labels,datasets:[{label:"PM2.5 Âµg/mÂ³",data:values,borderWidth:2}]},
    options:{responsive:true,plugins:{legend:{display:false}}}
  });
}

/* Top 10 */
function renderTop10(){
  let top=[...stations].sort((a,b)=>b.aqi-a.aqi).slice(0,10);
  let html="";
  top.forEach(s=>html+=`ğŸ‘‘ ${s.name} - ${s.aqi}<br>`);
  document.getElementById("top10").innerHTML=html;
}

/* GPS à¸«à¸²à¹ƒà¸à¸¥à¹‰à¸ªà¸¸à¸” */
function requestLocation(){
  navigator.geolocation.getCurrentPosition(pos=>{
    let userLat=pos.coords.latitude;
    let userLon=pos.coords.longitude;
    let nearest=stations.reduce((prev,curr)=>{
      let d1=Math.hypot(curr.lat-userLat,curr.lon-userLon);
      let d2=Math.hypot(prev.lat-userLat,prev.lon-userLon);
      return d1<d2?curr:prev;
    });
    document.getElementById("stationSelect").value=nearest.uid;
    loadStationDetail(nearest.uid);
    alert("ğŸ‘‘ à¹à¸ªà¸”à¸‡à¸ªà¸–à¸²à¸™à¸µà¹ƒà¸à¸¥à¹‰à¸„à¸¸à¸“à¸—à¸µà¹ˆà¸ªà¸¸à¸”à¹à¸¥à¹‰à¸§");
  });
}

loadStations();
</script>
</body>
</html>
