<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PM2.5 Thailand Ultra Complete</title>

<style>
body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,sans-serif;
    transition:0.4s;
    color:white;
}
.container{padding:15px;max-width:900px;margin:auto;}
.card{
    background:rgba(255,255,255,0.15);
    backdrop-filter:blur(12px);
    padding:20px;
    border-radius:20px;
    margin-bottom:20px;
}
h2,h3{text-align:center;}
.pm{font-size:64px;font-weight:bold;text-align:center;}
.status{text-align:center;font-weight:bold;margin-top:10px;}
button{
    width:100%;
    padding:12px;
    border:none;
    border-radius:12px;
    font-weight:bold;
    margin-top:10px;
}
table{width:100%;border-collapse:collapse;}
th,td{padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.2);}
.advice{margin-top:12px;font-size:14px;line-height:1.6;}
.footer{text-align:center;font-size:12px;margin-top:10px;opacity:0.8;}
</style>
</head>
<body>

<div class="container">

<div class="card">
<h2>üëë ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
<div class="pm" id="pm">--</div>
<div class="status" id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
<button onclick="loadData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
<div class="advice" id="advice"></div>
</div>

<div class="card">
<h3>üèÜ 10 ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡∏ù‡∏∏‡πà‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3>
<table id="table"></table>
</div>

<div class="footer">
‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏°‡∏•‡∏û‡∏¥‡∏© (Air4Thai) | ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å 1 ‡∏ô‡∏≤‡∏ó‡∏µ
</div>

</div>

<script>

const CACHE_TIME = 60000;

function getLevel(pm){
    if(pm<=25) return {text:"üü¢ ‡∏î‡∏µ‡∏°‡∏≤‡∏Å",color:"#00C853"};
    if(pm<=50) return {text:"üü° ‡∏î‡∏µ",color:"#FFD600"};
    if(pm<=100) return {text:"üü† ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö",color:"#FF6D00"};
    if(pm<=200) return {text:"üî¥ ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢",color:"#D50000"};
    return {text:"üü£ ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏°‡∏≤‡∏Å",color:"#6A1B9A"};
}

function getAdvice(pm){
    if(pm<=25) return "‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥";
    if(pm<=50) return "‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏ß‡∏£‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£";
    if(pm<=100) return "‡∏Ñ‡∏ß‡∏£‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å PM2.5 ‡πÅ‡∏•‡∏∞‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á";
    if(pm<=200) return "‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á ‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å N95";
    return "‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ü‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏®";
}

async function fetchAir4Thai(){

    const cache = localStorage.getItem("air_cache");
    const cacheTime = localStorage.getItem("air_time");

    if(cache && cacheTime && Date.now()-cacheTime < CACHE_TIME){
        return JSON.parse(cache);
    }

    const proxy = "https://api.allorigins.win/raw?url=" +
        encodeURIComponent("https://air4thai.pcd.go.th/services/getNewAQI_JSON.php");

    const res = await fetch(proxy);
    const data = await res.json();

    localStorage.setItem("air_cache",JSON.stringify(data));
    localStorage.setItem("air_time",Date.now());

    return data;
}

async function loadData(){

    try{
        const data = await fetchAir4Thai();

        if(!data.stations){
            throw "Invalid data";
        }

        const stations = data.stations
            .map(s=>({
                name:s.areaTH,
                pm:parseFloat(s.PM25?.value)
            }))
            .filter(s=>!isNaN(s.pm))
            .sort((a,b)=>b.pm-a.pm);

        renderTop10(stations);
        detectUserLocation(stations);

    }catch(e){
        document.getElementById("status").innerText="‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    }
}

function renderTop10(stations){
    const top10 = stations.slice(0,10);
    let html="<tr><th>#</th><th>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</th><th>PM2.5</th></tr>";
    top10.forEach((s,i)=>{
        html+=`<tr><td>${i+1}</td><td>${s.name}</td><td>${s.pm}</td></tr>`;
    });
    document.getElementById("table").innerHTML=html;
}

function detectUserLocation(stations){

    if(!navigator.geolocation){
        showFallback(stations[0]);
        return;
    }

    navigator.geolocation.getCurrentPosition(
        pos=>{
            // ‡πÉ‡∏ô GitHub Pages ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ map lat/lon ‡∏ï‡∏£‡∏á ‡πÜ ‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢
            // ‡πÉ‡∏ä‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÄ‡∏õ‡πá‡∏ô fallback ‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£
            showFallback(stations[0]);
        },
        ()=>showFallback(stations[0])
    );
}

function showFallback(station){
    const level = getLevel(station.pm);
    document.getElementById("pm").innerText=station.pm;
    document.getElementById("status").innerText=station.name+" "+level.text;
    document.getElementById("advice").innerText=getAdvice(station.pm);
    document.body.style.background=level.color;
}

window.onload=loadData;
setInterval(loadData,60000);

</script>

</body>
</html>
